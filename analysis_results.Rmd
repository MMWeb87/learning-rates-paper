---
title: "Result analysis"
output:
  html_document:
    df_print: paged
    toc_depth: '2'
  html_notebook: default
  pdf_document:
    highlight: zenburn
    keep_tex: yes
params:
  version: 'real'
  run_test: no
---

```{r setup, include=FALSE}

library(knitr)
library(ggsci)
library(tidyverse)
library(cowplot)
library(ggrepel)

source("init.R")
source("functions_learning.R")


knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.width=fig.width.baseline*output.size, 
  out.width=out.width.default)

theme_set(theme_bw(base_size = 9.5) + theme(legend.title=element_blank()))

```


We use this file to compare the final results from analysis_learningrates_corrections.


```{r load all results}

all_learnig_rates_results <- list()

for(currency in relevant_currencies){
  all_learnig_rates_results[[paste(currency,"real")]]  <- read_csv(paste0("output/results/learning_rate_results_",currency,"_real.csv"))
  all_learnig_rates_results[[paste(currency,"nominal")]]  <- read_csv(paste0("output/results/learning_rate_results_",currency,"_nominal.csv"))

}

```



```{r Combined plot, fig.cap="Learning rates plot", fig.asp=0.4}

mypal = pal_npg("nrc")(length(relevant_currencies))

plots <- list()

names(intervals) <- make_interval_names(intervals)

for(i in seq_along(intervals)){
  
  interval <- intervals[[i]]
  interval_name <- names(intervals[i])
  interval_years <- as.numeric(interval[1]):as.numeric(interval[2])
  
  x_text_shift <- function(type){
    shift = 0
    if(type == 1){
      shift = -10
    } else if(type == 2){
      shift = 10
    }
    
    return(shift)
  }
  

  
  plots[[interval_name]] <- reduce(all_learnig_rates_results, bind_rows) %>% 
    distinct() %>% 
    mutate(type = fct_relevel(type, "uncorrected", "uncorrected-weighted", "corrected")) %>% 
    arrange(currency, interval) %>% 
    ggplot(mapping = aes(x = type, y = rate, fill = currency)) +
      geom_col(position = "dodge2") +
      geom_text(. %>% filter(type == type), mapping = aes(y = rate/2, label = round(rate)), 
                position = position_dodge(0.9), col = "white", size = 2.8, angle = 90) +
      scale_y_continuous(limits = c(0,44), expand = expand_scale(mult = c(0, 0.1))) +
      labs(y = paste0("Learning rate in %")) +
      theme(
        axis.title.x = element_blank(),
        panel.grid.major = element_blank()) +
      facet_grid(version ~ interval) +
      scale_fill_npg()
}

# TODO: integrate in get_legend function
plot_legend <- plots[[1]] +
  theme(legend.position="bottom") +
  guides(
    fill = guide_legend(nrow=1,byrow=TRUE))

plots[[1]]

# plot_grid(
#   plot_grid(
#     plots[[1]] + theme(legend.position = "none"), 
#     plots[[2]] + theme(legend.position = "none", axis.title.y = element_blank()),
#     plots[[3]] + theme(legend.position = "none", axis.title.y = element_blank()), 
#     labels = c("a", "b", "c"), rel_widths = c(1,1,1), align = "h", ncol = 3),
#   get_legend(plot_legend), rel_heights = c(5,1),
#   ncol = 1)


```
