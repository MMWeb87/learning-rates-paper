---
title: "Result analysis"
output:
  html_document:
    df_print: paged
    toc_depth: '2'
  html_notebook: default
  pdf_document:
    highlight: zenburn
    keep_tex: yes
---

```{r setup, include=FALSE}

library(knitr)
library(ggsci)
library(tidyverse)
library(cowplot)
library(ggrepel)

source("init.R")
source("functions_learning.R")


knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.width=fig.width.baseline*output.size, 
  out.width=out.width.default)

theme_set(theme_bw(base_size = 9.5) + theme(legend.title=element_blank()))

```


We use this file to compare the final results from analysis_learningrates_corrections.


```{r load all results}

all_learnig_rates_results <- list()

for(currency in relevant_currencies){
  all_learnig_rates_results[[currency]]  <- read_csv(paste0("output/results/learning_rate_results_IRENA_",currency,".csv"))
}

```


```{r All results, fig.cap="All results", fig.asp=0.4}


```


```{r Combined plot, fig.cap="Learning rates plot", fig.asp=0.4}

mypal = pal_npg("nrc")(length(relevant_currencies))

plots <- list()

names(intervals) <- make_interval_names(intervals)

for(i in seq_along(intervals)){
  
  interval <- intervals[[i]]
  interval_name <- names(intervals[i])
  interval_years <- as.numeric(interval[1]):as.numeric(interval[2])
  
  x_text_shift <- function(type){
    shift = 0
    if(type == 1){
      shift = -10
    } else if(type == 2){
      shift = 10
    }
    
    return(shift)
  }
  

  
  plots[[interval_name]] <- reduce(all_learnig_rates_results, bind_rows) %>% 
    distinct() %>% 
    mutate(type = fct_relevel(type, "uncorrected", "uncorrected-weighted", "corrected")) %>% 
    filter(interval == interval_name) %>%
    arrange(currency, interval) %>% 
    ggplot(mapping = aes(x = currency, y = rate, alpha = type, group = type, fill = currency)) +
      geom_col(position = "dodge2") +
      geom_text(. %>% filter(type == "uncorrected"), mapping = aes(y = rate/2, label = round(rate)), nudge_x = -0.3, col = "white", size = 2.8, angle = 90) +
      geom_text(. %>% filter(type == "uncorrected-weighted"), mapping = aes(y = rate/2, label = round(rate)), nudge_x = 0, col = "black", size =2.8, angle = 90) +
      geom_text(. %>% filter(type == "corrected"), mapping = aes(y = rate/2, label = round(rate)), nudge_x = 0.3, col = "black", size = 2.8, angle = 90) +

      scale_alpha_manual(values = c(1,0.75,0.4))   +
      #scale_fill_manual(values = c("#000000", "white", mypal)) +
      scale_y_continuous(limits = c(0,40), expand = expand_scale(mult = c(0, 0.1))) +
      labs(
        subtitle = interval_name, y = paste0("Learning rate in %")) +
      theme(
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        panel.grid.major = element_blank()) +
      scale_fill_npg()
}

# TODO: integrate in get_legend function
plot_legend <- plots[[1]] +
  theme(legend.position="bottom") +
  guides(
    fill = guide_legend(nrow=1,byrow=TRUE))

plot_grid(
  plot_grid(
    plots[[1]] + theme(legend.position = "none"), 
    plots[[2]] + theme(legend.position = "none", axis.title.y = element_blank()),
    plots[[3]] + theme(legend.position = "none", axis.title.y = element_blank()) , 
    labels = c("a", "b", "c"), rel_widths = c(1,1,1), align = "h", ncol = 3),
  get_legend(plot_legend), rel_heights = c(5,1),
  ncol = 1)


```
