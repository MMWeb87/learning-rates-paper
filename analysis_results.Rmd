---
title: "Result analysis"
output:
  html_document:
    df_print: paged
    toc_depth: '2'
  html_notebook: default
  pdf_document:
    highlight: zenburn
    keep_tex: yes
params:
  run_test: no
---

```{r setup, include=FALSE}

library(knitr)
library(ggsci)
library(tidyverse)
library(cowplot)
library(ggrepel)

source("init.R")
source("functions_learning.R")


knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.width=fig.width.baseline*output.size, 
  out.width=out.width.default)

theme_set(theme_bw(base_size = 9.5) + theme(legend.title=element_blank()))

```


We use this file to compare the final results from analysis_learningrates_corrections.

```{r load all results}

all_learnig_rates_results <- list()

for(currency in relevant_currencies){
  all_learnig_rates_results[[paste(currency,"real")]]  <- read_csv(paste0("output/results/learning_rate_results_",currency,"_real.csv"))
  all_learnig_rates_results[[paste(currency,"nominal")]]  <- read_csv(paste0("output/results/learning_rate_results_",currency,"_nominal.csv"))

}

```


```{r all_results_plot, fig.cap="Learning rates plot", fig.asp=0.4}

all_learnig_rates_results_plot_data <- all_learnig_rates_results %>%   
  reduce(bind_rows) %>% 
  distinct() %>% 
  mutate(
    type = fct_relevel(type, "uncorrected", "uncorrected-weighted", "corrected"),
    type = fct_recode(type,
       "Uncorrected \n project-wt." = "uncorrected",
       "Uncorrected \n market share-wt." = "uncorrected-weighted",
       "Fx-corrected \n market share-wt." = "corrected"),
    interval = fct_relevel(interval, factor_order_intervals),
    interval = fct_recode(interval,
       "Full 10-year interval (2006-2016)" = "2006-2016",
       "First 5-year interval (2006-2011)" = "2006-2011",
       "Second 5-year interval (2011-2016)" = "2011-2016")
    ) %>% 
  arrange(currency, interval)

plot_labels = all_learnig_rates_results_plot_data %>% 
  expand(version, interval) %>% 
  add_column(label = letters[seq( from = 1, to = 6 )])
  
all_learnig_rates_results_plot = all_learnig_rates_results_plot_data %>% 
  ggplot(mapping = aes(x = type, y = rate, fill = currency)) +
    geom_col(position = "dodge2") +
    geom_text(. %>% filter(type == type), mapping = aes(y = rate/2, label = round(rate)), 
              position = position_dodge(0.9), col = "white", size = 2.8, angle = 90) +
    geom_text(data = plot_labels, mapping = aes(x = 0.6, y = 43, label = label), fontface = "bold") +
    scale_y_continuous(limits = c(0,44), expand = expand_scale(mult = c(0, 0.1))) +
    labs(
      y = paste0("Learning rate in %")) +
    theme(
      axis.title.x = element_blank(),
      panel.grid.major = element_blank(),
      legend.position="bottom",
      legend.spacing.x = unit(0.1, 'cm')) +
    guides(
      fill = guide_legend(nrow = 1)) +
    facet_grid(version ~ interval, switch = "y") +
    scale_fill_manual(values = plot_colours_currencies)

all_learnig_rates_results_plot


```
